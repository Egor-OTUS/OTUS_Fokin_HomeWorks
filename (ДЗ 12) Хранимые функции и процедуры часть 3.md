Стек  
Virtual Box 7.2.4  
Ubuntu Server 25.10  
Характеристики ВМ  
RAM: 16GB  
CPU: 8 cores  
VDI(SSD): 200GB  
PostgreSQL 17

***Скрипт и развернутое описание задачи – в ЛК (файл hw_triggers.sql) или по ссылке: https://disk.yandex.ru/d/l70AvknAepIJXQ  
В БД создана структура, описывающая товары (таблица goods) и продажи (таблица sales).  
Есть запрос для генерации отчета – сумма продаж по каждому товару.  
БД была денормализована, создана таблица (витрина), структура которой повторяет структуру отчета.  
Создать триггер на таблице продаж, для поддержки данных в витрине в актуальном состоянии (вычисляющий при каждой продаже сумму и записывающий её в витрину)  
Подсказка: не забыть, что кроме INSERT есть еще UPDATE и DELETE***

Создаем структуру на основе файла https://disk.yandex.ru/d/l70AvknAepIJXQ  
Создаем таблицу goods  
<img width="689" height="115" alt="image" src="https://github.com/user-attachments/assets/45f25d23-53aa-4d31-8c92-79947af501a6" />

Данные в таблицу на основе файла не переносятся  
<img width="584" height="105" alt="image" src="https://github.com/user-attachments/assets/dab83382-910d-4db3-9ac9-a33fc27238b7" />

Исправляем и добавляем данные в таблицу goods  
<img width="615" height="67" alt="image" src="https://github.com/user-attachments/assets/e026a579-514e-49c8-b3b1-ca125d7a1e43" />

Создаем таблицу sales и добавляем в неё данные    
<img width="819" height="181" alt="image" src="https://github.com/user-attachments/assets/6db91406-6ae4-479c-9163-22266518837e" />

Создаем таблицу good_sum_mart, таблица на основе файла не создается  
<img width="437" height="154" alt="image" src="https://github.com/user-attachments/assets/7c78c5b8-e6a6-45d0-b499-92c790b2d5d2" />

Исправляем и создаем таблицу  
<img width="490" height="119" alt="image" src="https://github.com/user-attachments/assets/b7196f35-f80a-478c-96ff-4a6373dc026c" />

Создаем функцию update_good_sum_mart() для INSERT, UPDATE и DELETE   
<img width="728" height="536" alt="image" src="https://github.com/user-attachments/assets/f9d32822-72d3-4897-86c3-5b871bbc530d" />

Проверяем наличие функции  
<img width="643" height="134" alt="image" src="https://github.com/user-attachments/assets/02ba549f-cca5-438f-85ba-3a5334ff4def" />

Создаем тригер tr_sales_update_good_sum_mart привязываясь к таблице sales на основе функции update_good_sum_mart  
<img width="531" height="80" alt="image" src="https://github.com/user-attachments/assets/109a1c2c-614d-4a6f-8eb0-b4e1e0edc6c5" />

Проверяем наличие тригера таблицы sales  
<img width="1039" height="275" alt="image" src="https://github.com/user-attachments/assets/9505a56f-9d21-4770-a327-c4f94064c01d" />




**Функция**  

CREATE OR REPLACE FUNCTION update_good_sum_mart()  
RETURNS TRIGGER AS $$  
BEGIN  
    IF TG_OP = 'INSERT' THEN  
        INSERT INTO good_sum_mart (good_name, sum_sale)  
        SELECT g.good_name, NEW.sales_qty * g.good_price    
        FROM goods g  
        WHERE g.goods_id = NEW.good_id  
        ON CONFLICT (good_name) DO UPDATE  
            SET sum_sale = good_sum_mart.sum_sale + NEW.sales_qty * (
                SELECT good_price FROM goods WHERE goods_id = NEW.good_id  
            );

    ELSIF TG_OP = 'UPDATE' THEN  
        UPDATE good_sum_mart  
        SET sum_sale = sum_sale   
            - OLD.sales_qty * (SELECT good_price FROM goods WHERE goods_id = OLD.good_id)  
            + NEW.sales_qty * (SELECT good_price FROM goods WHERE goods_id = NEW.good_id)  
        WHERE good_name = (SELECT good_name FROM goods WHERE goods_id = NEW.good_id);  

    ELSIF TG_OP = 'DELETE' THEN  
        UPDATE good_sum_mart  
        SET sum_sale = sum_sale - OLD.sales_qty * (  
            SELECT good_price FROM goods WHERE goods_id = OLD.good_id  
        )  
        WHERE good_name = (SELECT good_name FROM goods WHERE goods_id = OLD.good_id);  
    END IF;  

    RETURN NULL;  
END;  
$$ LANGUAGE plpgsql;  







